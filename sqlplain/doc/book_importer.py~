import re, csv, itertools
from sqlplain.namedtuple import namedtuple

Book = namedtuple('title author genre nation date')

BOOKFILE = re.compile('books(\d\d)')

class BookImporter(object):
    def __init__(self, db):
        self.db = db
        self.bookid = KTable.reflect(db, 'bookid')
        self.book = KTable.reflect(db, 'book')
        self.counter = itertools.count(1)

    def import_year(self, books, year):
        for b in books:
            self.bookid.insert_row(
                id = self.counter.next(),
                title = b.title,
                author = b.author,
                rdate = b.date)

    def import_all(self, dirname):
        n = 0
        for fname in os.listdir(dirname):
            mo = BOOKFILE.match(fname)
            f = file(os.path.join(dirname, fname))
            if mo:
                yy = int(mo.group(1))
                if yy > 80:
                    year = 1900 + yy
                else:
                    year = 2000 + y
                rows = map(Book, csv.reader(f))
                f.close()
                self.import_year(rows, year)

