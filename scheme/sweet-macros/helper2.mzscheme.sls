#!r6rs
(library (sweet-macros helper2)
(export locally syntax-match)
(import (rnrs) (for (rnrs) (meta -1))
(for (sweet-macros helper1) (meta -1) (meta 0) (meta 1)))

(define-syntax syntax-match
  (guarded-syntax-case () (sub locally)
    ((self (locally (let-form name value) ...) (literal ...)
           (sub patt skel . rest) ...)
     #'(locally (let-form name value) ...
         (guarded-syntax-case ()
           (<literals> <patterns> <source> <transformer> literal ...)
           ((ctx <literals>)
            #''(literal ...))
           ((ctx <patterns>)
            #''((... (... patt)) ...))
           ((ctx <source>)
            #''(self (locally (let-form name value) ...) (literal ...)
                     (... (... (sub patt skel . rest))) ...))
           ((ctx <transformer>)
            #'(self (locally (let-form name value) ...) (literal ...)
                    (... (... (sub patt skel . rest))) ...))
           (patt skel . rest) ...))
     (for-all identifier? #'(literal ...))
     (syntax-violation 'syntax-match "Found non identifier" #'(literal ...)
                       (remp identifier? #'(literal ...))))
    
    ((self (literal ...) (sub patt skel . rest) ...)
     #'(self (locally)(literal ...) (sub patt skel . rest) ...))

    ((self x (literal ...) (sub patt skel . rest) ...)
     #'(guarded-syntax-case x (literal ...) (patt skel . rest) ...))
    ))
)
